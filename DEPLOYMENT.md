# SkyFi MCP Server Deployment Guide

## Prerequisites

- [Fly.io account](https://fly.io/app/sign-up)
- [Fly CLI](https://fly.io/docs/hands-on/install-flyctl/) installed
- Fly CLI authenticated: `fly auth login`

## Initial Deployment

### 1. Launch the application

```bash
# From the project root
fly launch --no-deploy

# This will:
# - Create a new app (you can customize the name)
# - Set up the configuration
# - Create fly.toml if it doesn't exist
```

### 2. Set required secrets

```bash
# Generate and set the secret key base
fly secrets set SECRET_KEY_BASE=$(mix phx.gen.secret)
```

### 3. Create persistent volume for SQLite database

```bash
# Create a 1GB volume (adjust size as needed)
fly volumes create data --size 1

# For multiple regions, create a volume in each:
# fly volumes create data --size 1 --region sjc
# fly volumes create data --size 1 --region iad
```

### 4. Deploy the application

```bash
fly deploy
```

Your MCP server will be available at: `https://<your-app-name>.fly.dev`

## Managing Access Keys

Access keys control who can use your deployed MCP server. Each user needs TWO credentials:
1. **Access Key** (generated by admin) - validates MCP access
2. **SkyFi API Key** (user provides) - used for actual API requests

### Create an access key

```bash
# SSH into your Fly.io app
fly ssh console

# Generate a new access key
/app/bin/skyfi_mcp rpc "SkyfiMcp.AccessKey.create(\"user@example.com\", \"Description\")"
```

This will output:
```
Access key created successfully!
Email: user@example.com
Key: sk_mcp_abc123...
Description: Description
```

**Save this key securely** - it cannot be retrieved later.

### List all access keys

```bash
fly ssh console
/app/bin/skyfi_mcp rpc "SkyfiMcp.AccessKey.list_all()"
```

### Get access key statistics

```bash
fly ssh console
/app/bin/skyfi_mcp rpc "SkyfiMcp.AccessKey.get_stats(\"sk_mcp_...\")"
```

### Revoke an access key

```bash
fly ssh console
/app/bin/skyfi_mcp rpc "SkyfiMcp.AccessKey.revoke(\"sk_mcp_...\")"
```

## Configuration

### Environment Variables

Set via `fly secrets set`:

- `SECRET_KEY_BASE` (required) - Phoenix secret key
- `PHX_HOST` (optional) - Custom domain (defaults to fly.dev domain)
- `DATA` (optional) - Data directory path (defaults to `/data`)
- `PORT` (optional) - HTTP port (defaults to 8080)

### Scaling

#### VM Resources

```bash
# Scale to 1GB memory
fly scale memory 1024

# Scale to 2 CPUs
fly scale vm shared-cpu-2x
```

#### Auto-scaling

The default configuration auto-scales to 0 when idle to save costs:

```toml
[http_service]
  auto_stop_machines = true
  auto_start_machines = true
  min_machines_running = 0
```

To always keep instances running:

```bash
fly scale count 1 --max-per-region 1
```

### Custom Domain

```bash
# Add a custom domain
fly certs add api.yourdomain.com

# Follow DNS instructions from the output
```

## Monitoring

### View logs

```bash
# Real-time logs
fly logs

# Specific time range
fly logs --since 1h
```

### Health checks

The application exposes a health endpoint at `/health`:

```bash
curl https://<your-app-name>.fly.dev/health
```

### Metrics

```bash
# View app metrics
fly dashboard

# Or open in browser
fly open
```

## Testing the Deployment

### Test with curl

```bash
# Set your credentials
export ACCESS_KEY="sk_mcp_abc123..."
export SKYFI_API_KEY="your-skyfi-api-key"
export SERVER_URL="https://<your-app-name>.fly.dev"

# Test health endpoint (no auth required)
curl $SERVER_URL/health

# Test MCP message endpoint
curl -X POST $SERVER_URL/mcp/message \
  -H "Authorization: Bearer $ACCESS_KEY" \
  -H "X-SkyFi-API-Key: $SKYFI_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "tools/list",
    "id": 1
  }'
```

### Test with npm bridge (after setup)

```bash
npx @skyfi/mcp-client \
  --access-key sk_mcp_abc123... \
  --api-key your-skyfi-api-key \
  --server https://<your-app-name>.fly.dev
```

## Updating

```bash
# Deploy latest changes
fly deploy

# Rollback if needed
fly releases
fly releases rollback <version>
```

## Database Backup

SQLite database is stored in the persistent volume at `/data/skyfi_mcp.db`.

### Manual backup

```bash
# SSH into the machine
fly ssh console

# Create a backup
cp /data/skyfi_mcp.db /data/skyfi_mcp_backup_$(date +%Y%m%d).db

# Or download the database
fly ssh sftp get /data/skyfi_mcp.db ./skyfi_mcp.db
```

### Automated backups

Set up a scheduled job using [Fly.io Machines](https://fly.io/docs/machines/guides-examples/backup-databases/):

```bash
# Create a backup script
fly ssh console
cat > /app/backup.sh <<'EOF'
#!/bin/sh
BACKUP_FILE="/data/skyfi_mcp_backup_$(date +%Y%m%d_%H%M%S).db"
cp /data/skyfi_mcp.db "$BACKUP_FILE"
echo "Backup created: $BACKUP_FILE"
EOF
chmod +x /app/backup.sh
```

## Troubleshooting

### App won't start

```bash
# Check logs
fly logs

# Verify secrets are set
fly secrets list

# Verify volume is attached
fly volumes list
```

### Database errors

```bash
# SSH into app
fly ssh console

# Check database file
ls -lh /data/skyfi_mcp.db

# Check permissions
stat /data/skyfi_mcp.db
```

### Performance issues

```bash
# Check metrics
fly dashboard

# Scale up if needed
fly scale memory 1024
fly scale vm shared-cpu-2x
```

## Cost Optimization

- **Free tier**: Fly.io provides 3 shared-cpu-1x machines with 256MB RAM free
- **Auto-stop**: Configured to stop when idle (costs nothing when stopped)
- **Volume**: 1GB volume is free, 3GB total free per account
- **Estimated cost**: $0-5/month for light usage with auto-scaling

## Security Checklist

- [ ] `SECRET_KEY_BASE` is set and unique
- [ ] Access keys are distributed securely
- [ ] HTTPS is enabled (automatic with Fly.io)
- [ ] Health check endpoint is accessible
- [ ] Access keys are rotated periodically
- [ ] Inactive keys are revoked
- [ ] Request logs are monitored

## Support

- **Fly.io Docs**: https://fly.io/docs/
- **SkyFi MCP Issues**: https://github.com/yourusername/skyfi_mcp/issues
- **Fly.io Community**: https://community.fly.io/
